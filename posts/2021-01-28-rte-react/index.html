<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">
    
      <script data-ad-client="ca-pub-7171078376920665" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

    

    <meta name="author" content="Andy White">
    <meta name="description" content="Provides real-world examples of ways to use fp-ts and ReaderTaskEither with React">
    <meta name="keywords" content="blog,tech,developer,software,personal">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="TypeScript &#43; fp-ts: ReaderTaskEither and React"/>
<meta name="twitter:description" content="Provides real-world examples of ways to use fp-ts and ReaderTaskEither with React"/>

    <meta property="og:title" content="TypeScript &#43; fp-ts: ReaderTaskEither and React" />
<meta property="og:description" content="Provides real-world examples of ways to use fp-ts and ReaderTaskEither with React" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://andywhite.xyz/posts/2021-01-28-rte-react/" />
<meta property="article:published_time" content="2021-01-28T19:19:54-07:00" />
<meta property="article:modified_time" content="2021-01-28T19:19:54-07:00" />


    <title>
  TypeScript &#43; fp-ts: ReaderTaskEither and React · Andy White
</title>

    
      <link rel="canonical" href="https://andywhite.xyz/posts/2021-01-28-rte-react/">
    

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel="stylesheet">
    <link rel="preload" href="https://andywhite.xyz/fonts/forkawesome-webfont.woff2?v=1.1.7" as="font" type="font/woff2" crossorigin>

    
      
      
      <link rel="stylesheet" href="https://andywhite.xyz/css/coder.min.f48a4da9bd32cecaff90717ae85529411dd087c10fc0dfca9c9c329c7327e5e1.css" integrity="sha256-9IpNqb0yzsr/kHF66FUpQR3Qh8EPwN/KnJwynHMn5eE=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="https://andywhite.xyz/css/coder-dark.min.89c82b6022b96f77aeb521b240daec4f87ea029d84d1c78b8acd0735b91b3c92.css" integrity="sha256-icgrYCK5b3eutSGyQNrsT4fqAp2E0ceLis0HNbkbPJI=" crossorigin="anonymous" media="screen" />
      
    

    

    

    <link rel="icon" type="image/png" href="https://andywhite.xyz/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://andywhite.xyz/images/favicon-16x16.png" sizes="16x16">

    <link rel="apple-touch-icon" href="https://andywhite.xyz/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://andywhite.xyz/images/apple-touch-icon.png">

    

    <meta name="generator" content="Hugo 0.80.0" />
  </head>

  
  
    
  
  <body class="colorscheme-auto"
        onload=""
  >
    
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://andywhite.xyz/">
      Andy White
    </a>
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://andywhite.xyz/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://andywhite.xyz/projects/">Projects</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://andywhite.xyz/about/">About</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://andywhite.xyz/posts/2021-01-28-rte-react/">
              TypeScript &#43; fp-ts: ReaderTaskEither and React
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa fa-calendar" aria-hidden="true"></i>
              <time datetime='2021-01-28T19:19:54-07:00'>
                January 28, 2021
              </time>
            </span>
            <span class="reading-time">
              <i class="fa fa-clock-o" aria-hidden="true"></i>
              30-minute read
            </span>
          </div>
          
          <div class="categories">
  <i class="fa fa-folder" aria-hidden="true"></i>
    <a href="https://andywhite.xyz/categories/software-development/">Software Development</a>
      <span class="separator">•</span>
    <a href="https://andywhite.xyz/categories/functional-programming/">Functional Programming</a></div>

          <div class="tags">
  <i class="fa fa-tag" aria-hidden="true"></i>
    <a href="https://andywhite.xyz/tags/typescript/">TypeScript</a>
      <span class="separator">•</span>
    <a href="https://andywhite.xyz/tags/fp-ts/">fp-ts</a>
      <span class="separator">•</span>
    <a href="https://andywhite.xyz/tags/react/">React</a></div>

        </div>
      </header>

      <div>
        
        <h1 id="readertaskeitherr-e-a-and-react">
  ReaderTaskEither&lt;R, E, A&gt; and React
  <a class="heading-link" href="#readertaskeitherr-e-a-and-react">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<p>This article is intended to build up some intuitions about the <a href="https://github.com/gcanti/fp-ts/blob/master/src/ReaderTaskEither.ts">ReaderTaskEither&lt;R, E, A&gt;</a> type from <a href="https://gcanti.github.io/fp-ts/">fp-ts</a> and then present some real-world usage guides for using it with <a href="https://reactjs.org/">React</a>.</p>
<p>The code from this article is loosely based on some play-around/experimental code here: <a href="https://github.com/andywhite37/react-rte-experiment">https://github.com/andywhite37/react-rte-experiment</a></p>
<p>I&rsquo;d also recommend some similar posts about functional dependency injection - these articles are centered around F#, but the same concepts apply:</p>
<ul>
<li><a href="https://fsharpforfunandprofit.com/posts/dependency-injection-1/">Functional approches to dependency injection</a></li>
<li><a href="https://fsharpforfunandprofit.com/posts/dependencies/">Six approaches to dependency injection</a></li>
</ul>
<p>I&rsquo;d also recommend the <a href="https://zio.dev/">ZIO documentation</a> and all the community articles about ZIO for more information, ideas, and techniques.</p>
<p>Finally, I&rsquo;d also highly recommend looking into <a href="https://github.com/Effect-TS">effect-ts</a>, which is a super-modern, TypeScript-native implementation of these ideas, inspired by ZIO.</p>
<h1 id="overview">
  Overview
  <a class="heading-link" href="#overview">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<p>The first thing to note about <code>ReaderTaskEither&lt;R, E, A&gt;</code> is that it provides a ton of built-in functionality for doing all the common operations you&rsquo;d typically want from an &ldquo;effect type.&rdquo;</p>
<h2 id="the-type">
  The type
  <a class="heading-link" href="#the-type">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>As a reminder, the type of <code>RTE</code> is the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ReaderTaskEither</span>&lt;<span style="color:#f92672">R</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">E</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">A</span>&gt; <span style="color:#f92672">=</span> <span style="color:#a6e22e">Reader</span>&lt;<span style="color:#f92672">R</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">TaskEither</span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">E</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">A</span>&gt;<span style="color:#f92672">&gt;</span>
                               <span style="color:#f92672">=</span> <span style="color:#a6e22e">Reader</span>&lt;<span style="color:#f92672">R</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Task</span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">Either</span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">E</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">A</span>&gt;<span style="color:#f92672">&gt;&gt;</span>
                               <span style="color:#f92672">=</span> <span style="color:#a6e22e">Reader</span>&lt;<span style="color:#f92672">R</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#960050;background-color:#1e0010">()</span> <span style="color:#960050;background-color:#1e0010">=</span>&gt; <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">Either</span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">E</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">A</span>&gt;<span style="color:#f92672">&gt;</span>
                               <span style="color:#f92672">=</span> (<span style="color:#a6e22e">r</span>: <span style="color:#66d9ef">R</span>) <span style="color:#f92672">=&gt;</span> () <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">Either</span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">E</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">A</span>&gt;<span style="color:#f92672">&gt;</span>
</code></pre></div><p>The key thing to keep in mind is that the type of <code>RTE</code> is a <strong>function</strong> - not a static data structure like <code>Option</code> or <code>Either</code>. Because of this, the implementations of some of the functions like <code>map</code> may look or feel a little different than how they&rsquo;re implemented for the data structure types.</p>
<p>One intuition for <code>RTE</code> is that it&rsquo;s a &ldquo;canned effect&rdquo; that describes some operation that has some input(s), runs asynchronously and eventually completes with an error or success. You can combine and compose <code>RTE</code> effects that have different inputs, and that produce different errors or outputs. As you compose <code>RTE</code> effects, the input type will often &ldquo;widen&rdquo; (typically via <code>&amp;</code>), and the output types will widen or be combined depending on the type of combinator you&rsquo;re using. Eventually you&rsquo;ll have a complete program or RTE effect that fully describes all the necessary inputs and all the possible outputs.</p>
<h2 id="constructors">
  Constructors
  <a class="heading-link" href="#constructors">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>A <code>ReaderTaskEither&lt;R, E, A&gt;</code> can be constructed (or created) in a variety of ways:</p>
<h3 id="from-a-pure-value-of-type-a">
  From a pure value of type A
  <a class="heading-link" href="#from-a-pure-value-of-type-a">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<p>If you have a &ldquo;pure&rdquo; value that you simply want to &ldquo;lift&rdquo; into a <code>RTE</code>, you can use the standard function <code>of</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">myRTE1</span>: <span style="color:#66d9ef">ReaderTaskEither</span>&lt;<span style="color:#f92672">unknown</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">never</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">number</span>&gt; <span style="color:#f92672">=</span> <span style="color:#a6e22e">RTE</span>.<span style="color:#66d9ef">of</span>(<span style="color:#ae81ff">42</span>) <span style="color:#75715e">// explicit annotation
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">myRTE2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">RTE</span>.<span style="color:#66d9ef">of</span>(<span style="color:#ae81ff">42</span>) <span style="color:#75715e">// ReaderTaskEither&lt;unknown, unknown, number&gt; - unfortunate inference
</span></code></pre></div><p>Note that the type is annotated here with <code>unknown</code> for the <code>R</code> type (because the computation has no external dependency), and with <code>never</code> as the <code>E</code> type because we want to explicitly state via the types that this effect has no possibility of failure. If you don&rsquo;t annotate the type like this, TypeScript will infer the type as <code>ReaderTaskEither&lt;unknown, unknown, number&gt;</code>, which is unfortunate, because it infers <code>unknown</code> for <code>E</code> rather than <code>never</code>.</p>
<p>There is another constructor <code>RTE.right</code> that has better type inference than <code>of</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">myRTE</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">right</span>(<span style="color:#ae81ff">42</span>) <span style="color:#75715e">// ReaderTaskEither&lt;unknown, never, number&gt; - better inference than of
</span></code></pre></div><h3 id="from-an-error-value-of-type-e">
  From an error value of type E
  <a class="heading-link" href="#from-an-error-value-of-type-e">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<p>Similar to <code>RTE.right</code> to put a value in the <code>Right</code>, use <code>RTE.left</code> to put a value in the <code>Left</code> of the <code>Either</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">myRTE</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">left</span>({ <span style="color:#a6e22e">message</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Fail!&#39;</span> }) <span style="color:#75715e">// ReaderTaskEither&lt;unknown, { message: string }, never&gt;
</span></code></pre></div><p>Note that this type infers correctly, and the <code>A</code> type is set to <code>never</code> to correctly indicate that this <code>RTE</code> effect <strong>cannot be successful</strong>.</p>
<h3 id="from-a-taskltagt-or-taskltegt">
  From a Task&lt;A&gt; or Task&lt;E&gt;
  <a class="heading-link" href="#from-a-taskltagt-or-taskltegt">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<p>If you have a <code>Task</code> containing either an <code>A</code> value or an <code>E</code> value, you can &ldquo;lift&rdquo; it into a <code>RTE</code> using:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">myTaskA</span>: <span style="color:#66d9ef">Task</span>&lt;<span style="color:#f92672">number</span>&gt; <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">Promise</span>.<span style="color:#a6e22e">resolve</span>(<span style="color:#ae81ff">42</span>)

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">myTaskE</span>: <span style="color:#66d9ef">Task</span><span style="color:#f92672">&lt;</span>{ <span style="color:#a6e22e">message</span>: <span style="color:#66d9ef">string</span> }<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span>
  <span style="color:#a6e22e">Promise</span>.<span style="color:#a6e22e">resolve</span>({ <span style="color:#a6e22e">message</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Fail&#39;</span> })

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">myRTE</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">rightTask</span>(<span style="color:#a6e22e">myTaskA</span>) <span style="color:#75715e">// ReaderTaskEither&lt;unknown, never, number&gt;
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">myRTE</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">leftTask</span>(<span style="color:#a6e22e">myTaskE</span>) <span style="color:#75715e">// ReaderTaskEither&lt;unknown, { message: string }, never&gt;
</span></code></pre></div><p><code>RTE.leftTask</code> might seem a little strange, but remember that a <code>Task</code> does not have a way to express an error type <code>E</code>. The <code>rightTask</code>/<code>leftTask</code> constructors simply take the result of the <code>Task</code> (which should always be a resolved Promise) and put it into either the <code>Right</code> or <code>Left</code> channel of the <code>RTE</code>. If we are dealing with a <code>Promise&lt;A&gt;</code>/<code>Task&lt;A&gt;</code> that has the possibility of failure, we should be using a <code>TaskEither&lt;E, A&gt;</code>.</p>
<h3 id="from-a-promiseltagt">
  From a Promise&lt;A&gt;
  <a class="heading-link" href="#from-a-promiseltagt">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<p>Because <code>RTE</code> is backed by a <code>Promise</code>, it&rsquo;s easy to lift a <code>Promise&lt;A&gt;</code> into an <code>RTE</code>, but you need to be aware of some pitfalls.</p>
<p>Since a <code>Promise&lt;A&gt;</code> doesn&rsquo;t have a way of expressing a <code>Reader</code>-like &ldquo;input&rdquo; or dependency, we would expect for the <code>RTE</code> to have <code>unknown</code> as the <code>R</code> type. For the <code>E</code> type of the <code>RTE</code>, <code>Promise&lt;A&gt;</code> does not express a generic (or polymorphic) error type - it carries a &ldquo;hidden&rdquo; error type which manifests itself as an <code>any</code>. We don&rsquo;t want to deal with <code>any</code>, so in order to convert a <code>Promise&lt;A&gt;</code> into a <code>ReaderTaskEither&lt;R, E, A&gt;</code>, we need to explicitly convert this <code>any</code> error type into our well-known <code>E</code> type ourselves. <code>TaskEither</code> provides a <code>tryCatch</code> function that serves this purpose.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">myTaskEitherGood</span>: <span style="color:#66d9ef">TE.TaskEither</span><span style="color:#f92672">&lt;</span>
  { <span style="color:#a6e22e">message</span>: <span style="color:#66d9ef">string</span> },
  <span style="color:#66d9ef">number</span>
<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">TE</span>.<span style="color:#a6e22e">tryCatch</span>(
  () <span style="color:#f92672">=&gt;</span>
    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">number</span>&gt;((<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) <span style="color:#f92672">=&gt;</span> {
      <span style="color:#a6e22e">setTimeout</span>(() <span style="color:#f92672">=&gt;</span> {
        <span style="color:#a6e22e">resolve</span>(<span style="color:#ae81ff">42</span>)
      }, <span style="color:#ae81ff">100</span>)
    }),
  (<span style="color:#a6e22e">e</span>: <span style="color:#66d9ef">any</span>) <span style="color:#f92672">=&gt;</span> ({ <span style="color:#a6e22e">message</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Oops&#39;</span> }), <span style="color:#75715e">// Or do some runtime inspection of `e` to try to figure out what it is :(
</span><span style="color:#75715e"></span>)

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">myTaskEitherBad</span>: <span style="color:#66d9ef">TE.TaskEither</span><span style="color:#f92672">&lt;</span>{ <span style="color:#a6e22e">message</span>: <span style="color:#66d9ef">string</span> }, <span style="color:#66d9ef">number</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">TE</span>.<span style="color:#a6e22e">tryCatch</span>(
  () <span style="color:#f92672">=&gt;</span>
    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">number</span>&gt;((<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) <span style="color:#f92672">=&gt;</span> {
      <span style="color:#a6e22e">setTimeout</span>(() <span style="color:#f92672">=&gt;</span> {
        <span style="color:#a6e22e">reject</span>(<span style="color:#e6db74">&#39;Yolo&#39;</span>) <span style="color:#75715e">// Promise can be rejected with any value
</span><span style="color:#75715e"></span>      }, <span style="color:#ae81ff">100</span>)
    }),
  (<span style="color:#a6e22e">e</span>: <span style="color:#66d9ef">any</span>) <span style="color:#f92672">=&gt;</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;Yolo&#39;</span> <span style="color:#f92672">?</span> { <span style="color:#a6e22e">message</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Fail&#39;</span> } <span style="color:#f92672">:</span> { <span style="color:#a6e22e">message</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;I have no idea&#39;</span> }
  },
)
</code></pre></div><p>Any time you have to deal with a &ldquo;raw&rdquo; <code>Promise&lt;A&gt;</code>, you should wrap it in a <code>TE.tryCatch</code> like this, to ensure that if the <code>Promise</code> is rejected, the error will be properly converted into the <code>E</code> type, and lifted into the <code>Either&lt;E, A&gt;</code> in the <code>Promise&lt;Either&lt;E, A&gt;&gt;</code>. With <code>TaskEither</code> and <code>ReaderTaskEither</code>, we never want to be dealing with a rejected <code>Promise</code> under the hood, because that means we&rsquo;ve not properly handled the errors, and it will likely go uncaught and crash the program. <code>RTE</code> doesn&rsquo;t currently have it&rsquo;s own built-in <code>tryCatch</code> function like this, but it could be easily added as a helper function, and would likely just use <code>TE.tryCatch</code> like above, with the addition of an <code>unknown</code> <code>Reader</code> param.</p>
<p>Another thing to be aware of is that you should always try to deal with &ldquo;lazy&rdquo; <code>Promises</code> (i.e. <code>Task</code>-like types), if possible, because once a <code>Promise</code> is constructed, it immediately starts executing. If you take an already-running <code>Promise&lt;A&gt;</code> and wrap it in a <code>Task</code>, <code>TaskEither</code> or <code>ReaderTaskEither</code>, you are not actually getting the purity guarantee of the lazy types. However, when dealing with JS libs, you are sometimes just given a <code>Promise&lt;A&gt;</code>, so there are cases where you might have to just wrap it. To avoid that, try to invoke the JS lib lazily (i.e. in an <code>IO&lt;A&gt;</code>), so you can keep the <code>Promise</code> lazy until you want to actually run your <code>RTE</code>.</p>
<p>One final pitfall of <code>Task</code> to be aware of is the &ldquo;under-the-hood&rdquo; failure that can happen.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">myTaskA</span>: <span style="color:#66d9ef">Task</span>&lt;<span style="color:#f92672">number</span>&gt; <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">Promise</span>.<span style="color:#a6e22e">reject</span>(<span style="color:#e6db74">&#39;Oops&#39;</span>)
</code></pre></div><p>In this case, we are in trouble, because <code>Task</code> is not supposed to fail, but here, it has. This is something that you have to just be aware of when dealing with <code>Promise</code>s. You should almost always use <code>TaskEither</code> and lift the <code>Promise&lt;A&gt;</code> into <code>TaskEither&lt;E, A&gt;</code> to explicitly deal with any unexpected errors from the <code>Promise&lt;A&gt;</code>. You should probably only use <code>Task&lt;A&gt;</code> directly if you know for a fact that the <code>Promise&lt;A&gt;</code> <strong>cannot fail</strong>.</p>
<p><strong>Key takeaway</strong>: always wrap raw/unknown <code>Promise</code>s in a <code>TE.tryCatch</code> or <code>RTE.tryCatch</code>. Only use a <code>Task&lt;A&gt;</code> if you know <strong>for sure</strong> the promise can never be rejected.</p>
<h3 id="from-other-types-of-lower-level-effect-types">
  From other types of &ldquo;lower-level&rdquo; effect types
  <a class="heading-link" href="#from-other-types-of-lower-level-effect-types">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<p>There are a host of other functions that can &ldquo;lift&rdquo; values of less-capable effect types into a <code>ReaderTaskEither&lt;R, E, A&gt;</code>, but we won&rsquo;t go into detail on all of these. Basically the idea is if you have a type that is compatible with <code>RTE</code> (i.e. has the same or subset of its capabilities), there should be a way to lift it into an <code>RTE</code>. Just look at the types of the inputs and outputs of the function.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">rightReader</span>
<span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">leftReader</span>
<span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">rightReaderTask</span>
<span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">leftReaderTask</span>
<span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">fromIOEither</span>
<span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">fromReaderEither</span>
<span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">rightIO</span>
<span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">leftIO</span>
</code></pre></div><h2 id="map-and-functor">
  map and Functor
  <a class="heading-link" href="#map-and-functor">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p><code>RTE</code> has a <code>map</code> function and a corresponding instance of the <code>Functor</code> typeclass, which means you convert the &ldquo;output&rdquo; value from one type to another using a pure function.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#a6e22e">pipe</span>(
  <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">right</span>(<span style="color:#ae81ff">42</span>)
  <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">n</span>: <span style="color:#66d9ef">number</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">n</span>.<span style="color:#a6e22e">toString</span>()),
)
</code></pre></div><p>Just like any other <code>Functor</code>, you should not do any side-effects, throw errors, etc. when using <code>map</code>.</p>
<h2 id="apply-apply-and-applicative">
  apply, Apply, and Applicative
  <a class="heading-link" href="#apply-apply-and-applicative">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p><code>RTE</code> also has an <code>apply</code> function and corresponding <code>Apply</code> and <code>Applicative</code> instances, so we can compose &ldquo;parallel&rdquo; or &ldquo;independent&rdquo; <code>RTE</code> operations. To relate this to <code>Promise&lt;A&gt;</code>, it&rsquo;s the same idea as <code>Promise.all([...])</code>. The parallel behavior is provided by the <code>apply</code> function and it&rsquo;s corresponding <code>Apply</code>/<code>Applicative</code> instance, but we most commonly do parallel/independent operations using <code>sequenceS</code> and <code>sequenceT</code>. We&rsquo;ll get more into how <code>RTE</code>s compose later after discussing the <code>Reader</code> part, but know that you can do <code>sequenceS</code> and <code>sequenceT</code> with <code>RTE</code>, just like you can with types like <code>Option</code>, <code>Either</code>, or <code>RemoteData</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#75715e">// 3 independent effects
</span><span style="color:#75715e">// None of these have run yet - they just describe some operations we want to do
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">myRTE1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">right</span>(<span style="color:#ae81ff">1</span>)
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">myRTE2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">right</span>(<span style="color:#ae81ff">2</span>)
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">myRTE3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">right</span>(<span style="color:#ae81ff">3</span>)

<span style="color:#75715e">// Create a new effect that combines the 3 effects together into a &#34;final&#34; object result
</span><span style="color:#75715e">// Note: the effects still haven&#39;t run yet - the result is only computed when this outer
</span><span style="color:#75715e">// RTE is run.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">myRTEAll</span>: <span style="color:#66d9ef">ReaderTaskEither</span><span style="color:#f92672">&lt;</span>
  <span style="color:#66d9ef">unknown</span>,
  <span style="color:#66d9ef">never</span>,
  { <span style="color:#a6e22e">value1</span>: <span style="color:#66d9ef">number</span>; <span style="color:#a6e22e">value2</span>: <span style="color:#66d9ef">number</span>; <span style="color:#a6e22e">value3</span>: <span style="color:#66d9ef">number</span> }
<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sequenceS</span>(<span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">readerTaskEither</span>)({
  <span style="color:#a6e22e">value1</span>: <span style="color:#66d9ef">myRTE1</span>,
  <span style="color:#a6e22e">value2</span>: <span style="color:#66d9ef">myRTE2</span>,
  <span style="color:#a6e22e">value3</span>: <span style="color:#66d9ef">myRTE3</span>,
})
</code></pre></div><p>How the <code>R</code> and <code>E</code> types are handled here will be covered later, but note that similar to <code>Promise.all</code>, this operation takes 3 independent effects, and is able to combine them all together.</p>
<h2 id="chain-and-monad">
  chain and Monad
  <a class="heading-link" href="#chain-and-monad">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p><code>RTE</code> has a <code>chain</code> and corresponding <code>Monad</code> instance too, so you can compose <code>RTE</code> effects in a sequential order, just like what you can do with <code>Option</code>, <code>Either</code>, etc. The idea with <code>chain</code> is that you have the ability to chain <code>RTE</code> effects together so that the value produced by one can be the input to the next effectful computation, and so on. This is all done lazily via function composition, so none of the effects are actually run until you tell it to at the end. We&rsquo;ll explore this more after seeing the <code>Reader</code> part. Below is a uselessly simple example, and will be expanded upon later.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#a6e22e">pipe</span>(
  <span style="color:#a6e22e">RTE</span>.<span style="color:#66d9ef">of</span>(<span style="color:#ae81ff">42</span>),
  <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">chain</span>(<span style="color:#a6e22e">n</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">RTE</span>.<span style="color:#66d9ef">of</span>(<span style="color:#a6e22e">n</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>)),
  <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">chain</span>(<span style="color:#a6e22e">n</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">RTE</span>.<span style="color:#66d9ef">of</span>(<span style="color:#a6e22e">n</span>.<span style="color:#a6e22e">toString</span>())),
)
</code></pre></div><h2 id="other-chain-variants">
  Other chain variants
  <a class="heading-link" href="#other-chain-variants">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>When using a monad to chain computations, you have to &ldquo;stay within the same monad&rdquo; throughout your computation. I.e. if you&rsquo;re doing a computation in <code>Option</code>, you have to normalize all your operations to deal in <code>Option</code>. This is often done by lifting other types of computations into the target monad, like if you have a computation that results in <code>A | null</code>, you lift that type into <code>Option&lt;A&gt;</code> using <code>O.fromNullable</code> in order to use <code>Option</code>-based combinators on it. The same is true about <code>RTE</code>; however, <code>RTE</code> is a multi-faceted monad in terms of capabilities (supports input, is async, can fail), and a lot of times you might need to do operations in less-capable monads. E.g. you might need to use a function like <code>(x: unknown) =&gt; Either&lt;E, A&gt;</code> to decode a value in the middle of an <code>RTE</code> computation. fp-ts provides some helper functions for &ldquo;lifting&rdquo; these lower-level types into <code>RTE</code>. These operations are named like <code>chain{Monad}K</code> or sometimes <code>chain{Monad}KW</code>, e.g. <code>chainTaskEitherK</code> or <code>chainTaskEitherKW</code>. For reference, if you&rsquo;re chaining another <code>RTE</code>-based computation, you&rsquo;d just use <code>chain</code> or <code>chainW</code>. The <code>K</code> stands for <code>Kleisli</code> - a <code>Kleisli</code> is simply a monadic (aka effectful) function of the form <code>(a: A) =&gt; F&lt;B&gt;</code> where <code>F</code> is any monadic type constructor. The <code>W</code> stands for &ldquo;widen,&rdquo; which means the function will automatically &ldquo;widen&rdquo; the reader input type using <code>&amp;</code> and widen the error type using <code>|</code>.</p>
<p>For example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#a6e22e">pipe</span>(
  <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">right</span>(<span style="color:#ae81ff">42</span>),
  <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">chain</span>(<span style="color:#a6e22e">n</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">RTE</span>.<span style="color:#66d9ef">of</span>(<span style="color:#a6e22e">n</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>)), <span style="color:#75715e">// Normal chain - chaining an RTE computation on an RTE
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">chainTaskEitherK</span>(<span style="color:#a6e22e">n</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">TE</span>.<span style="color:#a6e22e">right</span>(<span style="color:#a6e22e">n</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>)), <span style="color:#75715e">// Chain a TE-based computation on an RTE
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">chainEitherK</span>(<span style="color:#a6e22e">n</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">E</span>.<span style="color:#a6e22e">right</span>(<span style="color:#a6e22e">n</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>)), <span style="color:#75715e">// Chain an Either-based computation
</span><span style="color:#75715e"></span>)
</code></pre></div><p>When writing functions, try to use the correct monad in terms of capabilities, e.g. don&rsquo;t use <code>RTE</code> on things that can be done with just <code>Either</code>. Follow the &ldquo;principle of least power&rdquo; - only depend on types that provide the minimum set of capabilities you need to do your work, and avoid writing functions in <code>RTE</code> just for the sake of convenience. fp-ts provides many helper functions for combining these types, so it&rsquo;s valuable to review the full API and see how the different types can be combined.</p>
<h2 id="alt-and-alternative">
  alt and Alternative
  <a class="heading-link" href="#alt-and-alternative">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>One lesser-known way of composing effect types is the <code>alt</code> function. This function can be thought of as an &ldquo;or else&rdquo; operation - you run an effect, and if it happens to fail, you provide another effect to try, and so-on. The fallback effects are expressed lazily, so they will only run if needed.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#a6e22e">pipe</span>(
  <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">left</span>(<span style="color:#e6db74">&#39;Fail&#39;</span>),
  <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">alt</span>(() <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">left</span>(<span style="color:#e6db74">&#39;Tried again and failed&#39;</span>)),
  <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">alt</span>(() <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">right</span>(<span style="color:#ae81ff">42</span>)),
  <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">alt</span>(() <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">left</span>(<span style="color:#e6db74">&#39;This will never run&#39;</span>)),
)
</code></pre></div><h1 id="the-reader-part">
  The Reader part
  <a class="heading-link" href="#the-reader-part">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<p>So far, we have not seen what the <code>Reader</code> and its <code>R</code> parameter are for. <code>Reader</code> is simply just a function <code>(r: R) =&gt; A</code>, but the <code>R</code> parameter gives you the ability to make your computation abstract based on some externally-provided dependency. This seems ridiculously simple, but if you think about many effect types that don&rsquo;t have a <code>Reader</code>, the inputs to the computation have to be provided from some implicit environmental context or closure - you can&rsquo;t express the inputs in the effect type itself. <code>Reader</code> lets us express that type and abstract on it. The <code>R</code> type can be whatever type you want, but in the real world, the common way using <code>R</code> is to make it an object containing a key for each individual dependency you need for your computation. Sometimes this concept is easier to explain with a realistic example.</p>
<p>Before we jump into examples, one key function to understand with <code>RTE</code> is <code>RTE.ask</code> (or the related <code>RTE.asks</code>). <code>ReaderTaskEither&lt;R, E, A&gt;</code> can be expressed as a function like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">rte</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">r</span>: <span style="color:#66d9ef">boolean</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">TaskEither</span>&lt;<span style="color:#f92672">string</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">number</span>&gt; <span style="color:#f92672">=&gt;</span>
  <span style="color:#a6e22e">r</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">TE</span>.<span style="color:#a6e22e">right</span>(<span style="color:#ae81ff">42</span>) <span style="color:#f92672">:</span> <span style="color:#a6e22e">TE</span>.<span style="color:#a6e22e">left</span>(<span style="color:#e6db74">&#39;oops&#39;</span>)
</code></pre></div><p>Here we have explicitly separated out the <code>Reader</code> argument <code>(r: boolean)</code> so we can use it within the implementation. However, you can write an <code>RTE</code> without the explicit <code>(r: R)</code> argument like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">rte</span>: <span style="color:#66d9ef">ReaderTaskEither</span>&lt;<span style="color:#f92672">boolean</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">string</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">number</span>&gt; <span style="color:#f92672">=</span> <span style="color:#a6e22e">pipe</span>(
  <span style="color:#75715e">// How do we get `r`?
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">RTE</span>.<span style="color:#66d9ef">of</span>(<span style="color:#ae81ff">42</span>),
)
</code></pre></div><p>If you are using this way, it seems there&rsquo;s no way to access the <code>R</code> value, since we don&rsquo;t have the explicit argument for it. The <code>ask</code> function is the way you get the <code>R</code> - it basically is just an <code>RTE</code> combinator, that takes the <code>Reader</code> <code>R</code> input and passes it through to the <code>Reader</code>&rsquo;s output channel, so you can get to it by chaining or mapping on a continuation function after it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">rte</span>: <span style="color:#66d9ef">ReaderTaskEither</span>&lt;<span style="color:#f92672">boolean</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">string</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">number</span>&gt; <span style="color:#f92672">=</span> <span style="color:#a6e22e">pipe</span>(
  <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">ask</span>&lt;<span style="color:#f92672">boolean</span>&gt;(),
  <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">chainEitherK</span>((<span style="color:#a6e22e">r</span>: <span style="color:#66d9ef">boolean</span>) <span style="color:#f92672">=&gt;</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">E</span>.<span style="color:#a6e22e">right</span>(<span style="color:#ae81ff">42</span>) <span style="color:#f92672">:</span> <span style="color:#a6e22e">E</span>.<span style="color:#a6e22e">left</span>(<span style="color:#e6db74">&#39;oops&#39;</span>))),
)
</code></pre></div><p><code>RTE.asks</code> is similar to <code>ask</code>, but it just additionally lets you perform a function on <code>R</code> before passing it along - this would typically be to extract a specific sub-value out of the overall <code>R</code> &ldquo;environment&rdquo; value.</p>
<h1 id="real-world-example">
  Real-world example
  <a class="heading-link" href="#real-world-example">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<p>Let&rsquo;s say we want to write an application that can make an API call with <code>fetch</code>, and can interact with the browser&rsquo;s <code>localStorage</code>. Dealing with <code>fetch</code> involves asynchronous side effects, and dealing with <code>localStorage</code> involves synchronous side effects. We would like to write our business logic so we are not directly coupled to the actual browser <code>fetch</code> and <code>localStorage</code> implementations, so that we can mock these things for our unit tests, and to give ourselves the opportunity to change the implementations more easily down the road.</p>
<p>Let&rsquo;s start by writing interfaces for these &ldquo;services,&rdquo; so we can abstract the implementations:</p>
<h2 id="httpclient">
  HttpClient
  <a class="heading-link" href="#httpclient">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#75715e">// Error types
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HttpRequestError</span> <span style="color:#f92672">=</span> {
  <span style="color:#a6e22e">tag</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;httpRequestError&#39;</span>
  <span style="color:#a6e22e">error</span>: <span style="color:#66d9ef">unknown</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HttpContentTypeError</span> <span style="color:#f92672">=</span> {
  <span style="color:#a6e22e">tag</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;httpContentTypeError&#39;</span>
  <span style="color:#a6e22e">error</span>: <span style="color:#66d9ef">unknown</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HttpResponseStatusError</span> <span style="color:#f92672">=</span> {
  <span style="color:#a6e22e">tag</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;httpResponseStatusError&#39;</span>
  <span style="color:#a6e22e">status</span>: <span style="color:#66d9ef">number</span>
}

<span style="color:#75715e">// Interface
</span><span style="color:#75715e"></span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">HttpClient</span> {
  <span style="color:#a6e22e">request</span>(
    <span style="color:#a6e22e">input</span>: <span style="color:#66d9ef">RequestInfo</span>,
    <span style="color:#a6e22e">init?</span>: <span style="color:#66d9ef">RequestInit</span>,
  )<span style="color:#f92672">:</span> <span style="color:#a6e22e">TE</span>.<span style="color:#a6e22e">TaskEither</span>&lt;<span style="color:#f92672">HttpRequestError</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Response</span>&gt;
}

<span style="color:#75715e">// RTE &#34;module&#34; interface - for composing with other dependencies
</span><span style="color:#75715e"></span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">HttpClientEnv</span> {
  <span style="color:#a6e22e">httpClient</span>: <span style="color:#66d9ef">HttpClient</span>
}

<span style="color:#75715e">// &#34;Live&#34; implementation backed by `fetch`
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fetchHttpClient</span>: <span style="color:#66d9ef">HttpClient</span> <span style="color:#f92672">=</span> {
  <span style="color:#a6e22e">request</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">input</span>, <span style="color:#a6e22e">init</span>) <span style="color:#f92672">=&gt;</span>
    <span style="color:#a6e22e">TE</span>.<span style="color:#a6e22e">tryCatch</span>(
      () <span style="color:#f92672">=&gt;</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#a6e22e">input</span>, <span style="color:#a6e22e">init</span>)
      },
      (<span style="color:#a6e22e">e</span>: <span style="color:#66d9ef">any</span>) <span style="color:#f92672">=&gt;</span> ({
        <span style="color:#a6e22e">tag</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;httpRequestError&#39;</span>,
        <span style="color:#a6e22e">error</span>: <span style="color:#66d9ef">e</span>,
      }),
    ),
}
</code></pre></div><p>The HTTP client interface is modeled as a function of the type:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript">(<span style="color:#a6e22e">input</span>: <span style="color:#66d9ef">RequestInit</span>, <span style="color:#a6e22e">init?</span>: <span style="color:#66d9ef">RequestInit</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">TaskEither</span>&lt;<span style="color:#f92672">HttpRequestError</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Response</span>&gt;
</code></pre></div><p>You might notice that a type of this form looks like a <code>Reader</code>, and you are correct - we could model this as a <code>ReaderTaskEither</code>, but with the <code>Reader</code> pattern, there can sometimes be a subtle distinction between a functions &ldquo;arguments&rdquo; and its &ldquo;dependencies,&rdquo; which sometimes boils down to a judgement call. In simple terms, the <code>Reader</code> arg is typically for abstract services or dependencies that typically bubble to the top of the program where you compose together all your dependencies; whereas, the &ldquo;arguments&rdquo; are things that you are directly operating on in your function, or arguments that wouldn&rsquo;t make sense to &ldquo;bubble up&rdquo; to the top of your program. Here, the <code>input</code> and <code>init</code> are treated as non-<code>Reader</code> arguments, because they will vary per call, and are not things that we&rsquo;d want to bubble up from this level. In our case, we have no dependency at all, so the effect is modeled as just a <code>TaskEither&lt;E, A&gt;</code> - an async effect that can fail - basically a better <code>Promise&lt;A&gt;</code></p>
<p>The other reason we&rsquo;re not using <code>Reader</code> for <code>HttpClient</code> is that the implementation of this <code>HttpClient</code> interface is expected to be the &ldquo;end of the line&rdquo; in terms of dependencies - things will depend on this interface, and this interface is not going to depend on anything else.</p>
<p>The other thing to note here is that we&rsquo;re modelling the <code>E</code> error type as a simple tagged wrapper around an <code>unknown</code> error emitted by <code>fetch</code>. You could do more runtime inspection of the <code>fetch</code> error and decompose this into more specific error types, but we&rsquo;ll just use this for demonstration purposes - this need for runtime inspection is one of the main reasons we don&rsquo;t want to deal with untyped errors - it&rsquo;s impossible to know what you&rsquo;re going to get at compile time. For the <code>request</code> function, we&rsquo;re just going to use the <code>RequestInfo</code>, <code>RequestInit</code>, and <code>Response</code> types you&rsquo;d normally use directly with <code>fetch</code>, but these could be abstracted more too if we wanted to. The <code>fetchHttpClient</code> is simply an implementation of our <code>HttpClient</code> interface, backed by the normal Web API <code>fetch</code> function, but wrapped in the safer <code>TE.tryCatch</code>.</p>
<h2 id="localstorage">
  localStorage
  <a class="heading-link" href="#localstorage">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>For <code>localStorage</code>, we want to abstract the side effects for testability, so we&rsquo;ll model it as a simple wrapper interface like below. Here, we&rsquo;re using <code>IO&lt;A&gt;</code> because these are synchronous effects that shouldn&rsquo;t fail. If these operations could <code>throw</code>, we&rsquo;d probably use <code>IOEither&lt;E, A&gt;</code> instead. You could also model this interface without <code>IO&lt;A&gt;</code>, and just make it directly effectful, but then the caller would likely have to wrap all the calls in <code>IO&lt;A&gt;</code> themselves to maintain purity. This is also sometimes a judgement call whether to impose effect types at the library level or application level, but we&rsquo;ll err on the side of enforced purity.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#75715e">// Interface
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Storage</span> {
  <span style="color:#a6e22e">getItem</span>(<span style="color:#a6e22e">key</span>: <span style="color:#66d9ef">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">IO</span>.<span style="color:#a6e22e">IO</span>&lt;<span style="color:#f92672">O.Option</span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">string</span>&gt;<span style="color:#f92672">&gt;</span>
  <span style="color:#a6e22e">setItem</span>(<span style="color:#a6e22e">key</span>: <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">IO</span>.<span style="color:#a6e22e">IO</span>&lt;<span style="color:#f92672">void</span>&gt;
}

<span style="color:#75715e">// RTE &#34;module&#34; interface - for composing with other dependencies
</span><span style="color:#75715e"></span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">StorageEnv</span> {
  <span style="color:#a6e22e">storage</span>: <span style="color:#66d9ef">Storage</span>
}

<span style="color:#75715e">// Implementation with DOM localStorage
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">domStorage</span>: <span style="color:#66d9ef">Storage</span> <span style="color:#f92672">=</span> {
  <span style="color:#a6e22e">getItem</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">key</span>: <span style="color:#66d9ef">string</span>) <span style="color:#f92672">=&gt;</span> () <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">O</span>.<span style="color:#a6e22e">fromNullable</span>(<span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">getItem</span>(<span style="color:#a6e22e">key</span>)),
  <span style="color:#a6e22e">setItem</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">key</span>: <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">string</span>) <span style="color:#f92672">=&gt;</span> () <span style="color:#f92672">=&gt;</span> {
    <span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">setItem</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span>)
  },
}
</code></pre></div><h2 id="rte-modules">
  RTE &ldquo;modules&rdquo;
  <a class="heading-link" href="#rte-modules">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>With <code>Reader</code> dependencies, a common pattern is to expose them as &ldquo;module&rdquo; interfaces that expose the service as a single object key. We did this above with <code>HttpClientEnv</code> and <code>StorageEnv</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">HttpClientEnv</span> {
  <span style="color:#a6e22e">httpClient</span>: <span style="color:#66d9ef">HttpClient</span>
}

<span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">StorageEnv</span> {
  <span style="color:#a6e22e">storage</span>: <span style="color:#66d9ef">Storage</span>
}
</code></pre></div><p>The idea with this is that when we start to compose <code>Reader</code> effects, we can combine the reader dependencies using a simple type-level <code>&amp;</code> intersection, like:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">httpClientEnv</span>: <span style="color:#66d9ef">HttpClientEnv</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">httpClient</span>: <span style="color:#66d9ef">fetchHttpClient</span> }

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">storageEnv</span>: <span style="color:#66d9ef">StorageEnv</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">storage</span>: <span style="color:#66d9ef">domStorage</span> }

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">AppEnv</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">HttpClientEnv</span> <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">StorageEnv</span> <span style="color:#75715e">// &amp; other envs types
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">appEnv</span>: <span style="color:#66d9ef">AppEnv</span> <span style="color:#f92672">=</span> { ...<span style="color:#a6e22e">httpClientEnv</span>, ...<span style="color:#a6e22e">storageEnv</span> <span style="color:#75715e">/* ...other impls */</span> } <span style="color:#75715e">// { httpClient, storage, ... }
</span></code></pre></div><p>The spread of each <code>env</code> module is just for convenience - each <code>env</code> module typically just has one key in it, which needs to just be a unique name for the particular service it contains. This is so when it&rsquo;s all spread together, we get a big object of all the services to pass as a <code>Reader</code> dependency arg.</p>
<p>One very important thing to note is that you should not write functions that depend on some mega <code>AppEnv</code> type. You should write functions that depend on the exact services that you need, and nothing more. If you depend on just <code>HttpClientEnv</code> and someone passes you the mega <code>AppEnv</code> object, it doesn&rsquo;t matter, because you are only looking at that one part of it, and the caller is simply over-providing the argument object. Over-providing (which is fine) is not the same as over-depending (which is not fine).</p>
<h2 id="rte-helper-functions">
  RTE helper functions
  <a class="heading-link" href="#rte-helper-functions">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>With dependencies like <code>HttpClient</code> and <code>Storage</code>, a common pattern is to &ldquo;re-expose&rdquo; these interface functions as top-level <code>Reader</code>-based functions that depend on the interface, so that we can use FP techniques for composing <code>RTE</code> operations:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">request</span> <span style="color:#f92672">=</span> (
  <span style="color:#a6e22e">input</span>: <span style="color:#66d9ef">RequestInfo</span>,
  <span style="color:#a6e22e">init?</span>: <span style="color:#66d9ef">RequestInit</span>,
)<span style="color:#f92672">:</span> <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">ReaderTaskEither</span>&lt;<span style="color:#f92672">HttpClientEnv</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">HttpRequestError</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Response</span>&gt; <span style="color:#f92672">=&gt;</span>
  <span style="color:#a6e22e">pipe</span>(
    <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">asks</span>&lt;<span style="color:#f92672">HttpClientEnv</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">never</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">HttpClient</span>&gt;(
      (<span style="color:#a6e22e">env</span>: <span style="color:#66d9ef">HttpClientEnv</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">httpClient</span>,
    ),
    <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">chainTaskEitherKW</span>((<span style="color:#a6e22e">httpClient</span>: <span style="color:#66d9ef">HttpClient</span>) <span style="color:#f92672">=&gt;</span>
      <span style="color:#a6e22e">httpClient</span>.<span style="color:#a6e22e">request</span>(<span style="color:#a6e22e">input</span>, <span style="color:#a6e22e">init</span>),
    ),
  )
</code></pre></div><p>In this <code>request</code> function, we&rsquo;ve sort of flipped the interface inside out - rather than an interface that has a function inside it, we have a top-level function that depends on the interface. We&rsquo;re doing this because now we have a function that we can compose with other <code>RTE</code> functions.</p>
<p>Here, we&rsquo;re making a function that takes <code>input</code> and <code>init</code> and <strong>returns</strong> a <code>ReaderTaskEither</code>, which specifies the <code>HttpClientEnv</code> interface as our <code>Reader</code> dependency. We&rsquo;re using the <code>asks</code> function to get access to the <code>HttpClientEnv</code> input and convert it to just the inner <code>HttpClient</code> that it carries. We then use a <code>chainTaskEitherK</code> to actually invoke the <code>httpClient.request</code> function. Recall that this function returned a <code>TaskEither</code>, because at that level, we had no <code>Reader</code> dependency.</p>
<p>Now we&rsquo;ll add a few more helper functions, and finally a more high-level helper that combines some of these &ldquo;lego pieces&rdquo;:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#75715e">// Helper for extracting `json` response into `unknown` for decoding
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">toJson</span> <span style="color:#f92672">=</span> (
  <span style="color:#a6e22e">response</span>: <span style="color:#66d9ef">Response</span>,
)<span style="color:#f92672">:</span> <span style="color:#a6e22e">TE</span>.<span style="color:#a6e22e">TaskEither</span>&lt;<span style="color:#f92672">HttpContentTypeError</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">unknown</span>&gt; <span style="color:#f92672">=&gt;</span>
  <span style="color:#a6e22e">TE</span>.<span style="color:#a6e22e">tryCatch</span>(
    () <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">json</span>(),
    (<span style="color:#a6e22e">e</span>: <span style="color:#66d9ef">any</span>) <span style="color:#f92672">=&gt;</span> ({ <span style="color:#a6e22e">tag</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;httpContentTypeError&#39;</span>, <span style="color:#a6e22e">error</span>: <span style="color:#66d9ef">e</span> }),
  )

<span style="color:#75715e">// Helper for validating response status
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ensureStatus</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">min</span>: <span style="color:#66d9ef">number</span>, <span style="color:#a6e22e">max</span>: <span style="color:#66d9ef">number</span>) <span style="color:#f92672">=&gt;</span> (
  <span style="color:#a6e22e">response</span>: <span style="color:#66d9ef">Response</span>,
)<span style="color:#f92672">:</span> <span style="color:#a6e22e">E</span>.<span style="color:#a6e22e">Either</span>&lt;<span style="color:#f92672">HttpResponseStatusError</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Response</span>&gt; <span style="color:#f92672">=&gt;</span>
  <span style="color:#a6e22e">min</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">status</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">status</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">max</span>
    <span style="color:#f92672">?</span> <span style="color:#a6e22e">E</span>.<span style="color:#a6e22e">right</span>(<span style="color:#a6e22e">response</span>)
    <span style="color:#f92672">:</span> <span style="color:#a6e22e">E</span>.<span style="color:#a6e22e">left</span>({ <span style="color:#a6e22e">tag</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;httpResponseStatusError&#39;</span>, <span style="color:#a6e22e">status</span>: <span style="color:#66d9ef">response.status</span> })

<span style="color:#75715e">// &#34;High-level&#34; helper for issuing a simple GET to a JSON endpoint
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getJson</span> <span style="color:#f92672">=</span> &lt;<span style="color:#f92672">A</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">DecodeError</span>&gt;(
  <span style="color:#a6e22e">url</span>: <span style="color:#66d9ef">string</span>,
  <span style="color:#a6e22e">decode</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">raw</span>: <span style="color:#66d9ef">unknown</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">E</span>.<span style="color:#a6e22e">Either</span>&lt;<span style="color:#f92672">DecodeError</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">A</span>&gt;,
)<span style="color:#f92672">:</span> <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">ReaderTaskEither</span><span style="color:#f92672">&lt;</span>
  <span style="color:#a6e22e">HttpClientEnv</span>,
  <span style="color:#f92672">|</span> <span style="color:#a6e22e">HttpRequestError</span>
  <span style="color:#f92672">|</span> <span style="color:#a6e22e">HttpContentTypeError</span>
  <span style="color:#f92672">|</span> <span style="color:#a6e22e">HttpResponseStatusError</span>
  <span style="color:#f92672">|</span> <span style="color:#a6e22e">DecodeError</span>,
  <span style="color:#a6e22e">A</span>
<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=&gt;</span>
  <span style="color:#a6e22e">pipe</span>(
    <span style="color:#a6e22e">request</span>(<span style="color:#a6e22e">url</span>),
    <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">chainEitherKW</span>(<span style="color:#a6e22e">ensureStatus</span>(<span style="color:#ae81ff">200</span>, <span style="color:#ae81ff">300</span>)), <span style="color:#75715e">// ensureStatus operates on Either, so lift it (and widen error type) with chainEitherKW
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">chainTaskEitherKW</span>(<span style="color:#a6e22e">toJson</span>), <span style="color:#75715e">// toJson operates on TaskEither, so lift into RTE (with widening)
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">chainEitherKW</span>(<span style="color:#a6e22e">decode</span>), <span style="color:#75715e">// decode operates on Either... same deal
</span><span style="color:#75715e"></span>  )
</code></pre></div><p><code>getJson</code> is a helper function that we&rsquo;ve built from the lower-level pieces. Note that this is not intended to be the be-all, end-all solution to GET requests - it&rsquo;s simply a helper that does a particular thing, because this is all we need to do. If we needed to check the response status and dispatch to different response handlers per status, we&rsquo;d need to do that here by using other <code>RTE</code> combinators. API clients are notorious for trying to &ldquo;do too much,&rdquo; and often it&rsquo;s better to have lower-level tools like this to combine for your particular use cases, rather than trying to write the one all-powerful function for all API calls.</p>
<h2 id="caching-function">
  Caching function
  <a class="heading-link" href="#caching-function">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>Now lets add a <code>localStorage</code>-based caching capability. This function could probably be simplified or done in a better way, but this is just for demonstration purposes.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getWithCache</span> <span style="color:#f92672">=</span> &lt;<span style="color:#f92672">A</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">RGet</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">EGet</span>&gt;(
  <span style="color:#a6e22e">key</span>: <span style="color:#66d9ef">string</span>,
  <span style="color:#a6e22e">codec</span>: <span style="color:#66d9ef">t.Type</span>&lt;<span style="color:#f92672">A</span>&gt;,
  <span style="color:#66d9ef">get</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">ReaderTaskEither</span>&lt;<span style="color:#f92672">RGet</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">EGet</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">A</span>&gt;,
)<span style="color:#f92672">:</span> <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">ReaderTaskEither</span>&lt;<span style="color:#f92672">StorageEnv</span> <span style="color:#960050;background-color:#1e0010">&amp;</span> <span style="color:#a6e22e">RGet</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">EGet</span> <span style="color:#960050;background-color:#1e0010">|</span> <span style="color:#a6e22e">t.Errors</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">A</span>&gt; <span style="color:#f92672">=&gt;</span>
  <span style="color:#a6e22e">pipe</span>(
    <span style="color:#75715e">// Get the Storage service from the Reader
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Side note: rather than `ask` here, we could have used an &#34;RTE helper function&#34; below that has a dependency on `StorageEnv`
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">asks</span>&lt;<span style="color:#f92672">StorageEnv</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">never</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Storage</span>&gt;(<span style="color:#a6e22e">env</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">storage</span>),
    <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">chainW</span>(<span style="color:#a6e22e">storage</span> <span style="color:#f92672">=&gt;</span>
      <span style="color:#a6e22e">pipe</span>(
        <span style="color:#75715e">// Try to get the item from the cache
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">fromIO</span>&lt;<span style="color:#f92672">unknown</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">never</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">O.Option</span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">string</span>&gt;<span style="color:#f92672">&gt;</span>(<span style="color:#a6e22e">storage</span>.<span style="color:#a6e22e">getItem</span>(<span style="color:#a6e22e">key</span>)),
        <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">chainW</span>((<span style="color:#a6e22e">strOpt</span>: <span style="color:#66d9ef">O.Option</span>&lt;<span style="color:#f92672">string</span>&gt;) <span style="color:#f92672">=&gt;</span>
          <span style="color:#a6e22e">pipe</span>(
            <span style="color:#a6e22e">strOpt</span>,
            <span style="color:#a6e22e">O</span>.<span style="color:#a6e22e">fold</span>&lt;<span style="color:#f92672">string</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">RTE.ReaderTaskEither</span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">RGet</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">EGet</span> <span style="color:#960050;background-color:#1e0010">|</span> <span style="color:#a6e22e">t.Errors</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">A</span>&gt;<span style="color:#f92672">&gt;</span>(
              () <span style="color:#f92672">=&gt;</span>
                <span style="color:#75715e">// Cache miss - make the get call and cache the result
</span><span style="color:#75715e"></span>                <span style="color:#a6e22e">pipe</span>(
                  <span style="color:#66d9ef">get</span>,
                  <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">chainW</span>((<span style="color:#a6e22e">a</span>: <span style="color:#66d9ef">A</span>) <span style="color:#f92672">=&gt;</span>
                    <span style="color:#a6e22e">pipe</span>(
                      <span style="color:#a6e22e">a</span>, <span style="color:#75715e">// A
</span><span style="color:#75715e"></span>                      <span style="color:#a6e22e">codec</span>.<span style="color:#a6e22e">encode</span>, <span style="color:#75715e">// unknown
</span><span style="color:#75715e"></span>                      <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>, <span style="color:#75715e">// string
</span><span style="color:#75715e"></span>                      <span style="color:#a6e22e">str</span> <span style="color:#f92672">=&gt;</span>
                        <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">fromIO</span>&lt;<span style="color:#f92672">unknown</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">never</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">void</span>&gt;(
                          <span style="color:#a6e22e">storage</span>.<span style="color:#a6e22e">setItem</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">str</span>),
                        ),
                      <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">_</span> <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">a</span>),
                    ),
                  ),
                ),
              <span style="color:#a6e22e">str</span> <span style="color:#f92672">=&gt;</span>
                <span style="color:#75715e">// Cache hit - parse and decode the item and return it
</span><span style="color:#75715e"></span>                <span style="color:#a6e22e">pipe</span>(
                  <span style="color:#a6e22e">str</span>, <span style="color:#75715e">// string
</span><span style="color:#75715e"></span>                  <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>, <span style="color:#75715e">// unknown
</span><span style="color:#75715e"></span>                  <span style="color:#a6e22e">codec</span>.<span style="color:#a6e22e">decode</span>, <span style="color:#75715e">// A
</span><span style="color:#75715e"></span>                  <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">fromEither</span>,
                ),
            ),
          ),
        ),
      ),
    ),
  )
</code></pre></div><p>This function uses the <code>StorageEnv</code> and an arbitrary <code>get</code> effect (with it&rsquo;s own <code>RGet</code> and <code>EGet</code>) to try to get an item from the localStorage-based cache, and if it is not found, issue the <code>get</code> request and cache the result. The resulting <code>RTE</code> type tells the story of what this effect does:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">RTE.ReaderTaskEither&lt;StorageEnv &amp; RGet, EGet | t.Errors, A&gt;
</code></pre></div><p>This <code>getWithCache</code> effect depends on both the <code>StorageEnv</code> and whatever <code>REnv</code> the <code>get</code> effect requires in order to run. The effect can fail with either a <code>t.Errors</code> decode error (from the <code>io-ts</code> <code>t.Type&lt;A&gt;</code>), or an <code>EGet</code> failure from the <code>get</code> effect. Finally, if successful, the output type is <code>A</code>, which can either come from the cache, or the <code>get</code>.</p>
<h2 id="domain-level-effects">
  Domain-level effects
  <a class="heading-link" href="#domain-level-effects">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>Finally, let&rsquo;s try to write a real domain-level function using these parts. Let&rsquo;s fetch the breeds from the Dogs API, and then add a function for doing that with the added caching:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">breedsCodec</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">t</span>.<span style="color:#66d9ef">type</span>({
  <span style="color:#a6e22e">message</span>: <span style="color:#66d9ef">t.record</span>(<span style="color:#a6e22e">t</span>.<span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">array</span>(<span style="color:#a6e22e">t</span>.<span style="color:#66d9ef">string</span>)),
})

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Breeds</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">TypeOf</span>&lt;<span style="color:#f92672">typeof</span> <span style="color:#a6e22e">breedsCodec</span>&gt;

<span style="color:#75715e">// Get breeds via the HTTP API
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getBreeds</span>: <span style="color:#66d9ef">RTE.ReaderTaskEither</span><span style="color:#f92672">&lt;</span>
  <span style="color:#a6e22e">HttpClientEnv</span>,
  <span style="color:#a6e22e">HttpRequestError</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">HttpContentTypeError</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">HttpResponseStatusError</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errors</span>,
  <span style="color:#a6e22e">Breeds</span>
<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getJson</span>(<span style="color:#e6db74">&#39;https://dog.ceo/api/breeds/list/all&#39;</span>, <span style="color:#a6e22e">breedsCodec</span>.<span style="color:#a6e22e">decode</span>)

<span style="color:#75715e">// Add the cached version
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getBreedsWithCache</span>: <span style="color:#66d9ef">RTE.ReaderTaskEither</span><span style="color:#f92672">&lt;</span>
  <span style="color:#a6e22e">HttpClientEnv</span> <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">StorageEnv</span>,
  <span style="color:#a6e22e">HttpRequestError</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">HttpContentTypeError</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">HttpResponseStatusError</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errors</span>,
  <span style="color:#a6e22e">Breeds</span>
<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getWithCache</span>(<span style="color:#e6db74">&#39;breeds&#39;</span>, <span style="color:#a6e22e">breedsCodec</span>, <span style="color:#a6e22e">getBreeds</span>)
</code></pre></div><p>Notice the <code>R</code>, <code>E</code>, and <code>A</code> type params in these two functions. The first depends on <code>HttpClientEnv</code>, and the cached version adds the <code>&amp; StorageEnv</code>, because the <code>WithCache</code> function requires the <code>Storage</code> service too.</p>
<h2 id="using-the-service">
  Using the service
  <a class="heading-link" href="#using-the-service">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>Now we have a function <code>getBreedsWithCache</code> that we could use in a component. In order to call this function, we need to provide the <code>R</code> argument, namely a value of type <code>HttpClientEnv &amp; StorageEnv</code>. We need to get our hands on these services somehow, and there are a variety of ways of doing that, some of which incur some trade-offs in couple and convenience.</p>
<p>In React, it&rsquo;s typically discouraged to pass around dependencies as React component props, because that can cause unwanted extra renders, so one way to get access to higher-level dependencies is to use <code>Context</code>.</p>
<p>One way to achieve this is to create a <code>Context</code> and corresponding hook for each individual dependency, and the users of the services just need to make sure they are wrapped in a <code>Provider</code> for each layer.</p>
<h3 id="method-one---context-per-service">
  Method one - &ldquo;context per service&rdquo;
  <a class="heading-link" href="#method-one---context-per-service">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#75715e">// App.tsx
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// HTTP client module
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">httpClientEnv</span>: <span style="color:#66d9ef">HttpClientEnv</span> <span style="color:#f92672">=</span> {
  <span style="color:#a6e22e">httpClient</span>: <span style="color:#66d9ef">fetchHttpClient</span>,
}

<span style="color:#75715e">// HTTP client context
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">HttpClientContext</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">React</span>.<span style="color:#a6e22e">createContext</span>(<span style="color:#a6e22e">httpClientEnv</span>)

<span style="color:#75715e">// HTTP client context hook
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">useHttpClient</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">useContext</span>(<span style="color:#a6e22e">HttpClientContext</span>)

<span style="color:#75715e">// Storage module
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">storageEnv</span>: <span style="color:#66d9ef">StorageEnv</span> <span style="color:#f92672">=</span> {
  <span style="color:#a6e22e">storage</span>: <span style="color:#66d9ef">domStorage</span>,
}

<span style="color:#75715e">// Storage context
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">StorageContext</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">React</span>.<span style="color:#a6e22e">createContext</span>(<span style="color:#a6e22e">storageEnv</span>)

<span style="color:#75715e">// Storage custom hook
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">useStorage</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">useContext</span>(<span style="color:#a6e22e">StorageContext</span>)

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">App</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {
  <span style="color:#66d9ef">return</span> (
    &lt;<span style="color:#f92672">HttpClientContext.Provider</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">httpClientEnv</span>}&gt;
      &lt;<span style="color:#f92672">StorageContext.Provider</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">storageEnv</span>}&gt;
        &lt;<span style="color:#f92672">DogsApp</span> /&gt;
      &lt;/<span style="color:#f92672">StorageContext.Provider</span>&gt;
    &lt;/<span style="color:#f92672">HttpClientContext.Provider</span>&gt;
  )
}

<span style="color:#75715e">// DogsApp.tsx
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">DogsApp</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {

  <span style="color:#75715e">// This could all be wrapped up into another custom hook
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">httpClientEnv</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">useHttpClient</span>()
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">storageEnv</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">useStorage</span>()
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">env</span> <span style="color:#f92672">=</span> { ...<span style="color:#a6e22e">httpClientEnv</span>, ...<span style="color:#a6e22e">storageEnv</span> }

  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">remoteData</span>, <span style="color:#a6e22e">setRemoteData</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useState</span>&lt;<span style="color:#f92672">RD.RemoteData</span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">HttpError</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Breeds</span>&gt;(<span style="color:#a6e22e">RD</span>.<span style="color:#a6e22e">initial</span>)

  <span style="color:#a6e22e">useEffect</span>(() <span style="color:#f92672">=&gt;</span> {
    <span style="color:#a6e22e">setRemoteData</span>(<span style="color:#a6e22e">RD</span>.<span style="color:#a6e22e">pending</span>)
    <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">run</span>(<span style="color:#a6e22e">getBreedsWithCache</span>, <span style="color:#a6e22e">env</span>)
      .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">E</span>.<span style="color:#a6e22e">fold</span>(
        <span style="color:#a6e22e">e</span> <span style="color:#f92672">=&gt;</span> { <span style="color:#a6e22e">setRemoteData</span>(<span style="color:#a6e22e">RD</span>.<span style="color:#a6e22e">failure</span>(<span style="color:#a6e22e">e</span>) },
        <span style="color:#a6e22e">a</span> <span style="color:#f92672">=&gt;</span> { <span style="color:#a6e22e">setRemoteData</span>(<span style="color:#a6e22e">RD</span>.<span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">a</span>) },
      ))
  }, [])
  <span style="color:#75715e">// End stuff for custom hook
</span><span style="color:#75715e"></span>
  <span style="color:#75715e">// Render remoteData
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> &lt;&gt;...&lt;/&gt;
}
</code></pre></div><h3 id="method-two---single-appenv-context">
  Method two - single &ldquo;AppEnv&rdquo; context
  <a class="heading-link" href="#method-two---single-appenv-context">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<p>The other way of doing this is to create a single context that contains all the top-level app services, and basically &ldquo;over-depend&rdquo; on this big <code>AppEnv</code> bundle in your components. This method has the convenience that the <code>AppEnv</code> provides all possible dependencies can be passed into any function that depends on any subset of these dependencies. The big downside of this approach is that all the components that have <code>useAppEnv</code> are now coupled to the entire <code>AppEnv</code> dependency collection, so if you want to mock the dependencies, you have to mock all of <code>AppEnv</code>, rather than a smaller subset that you actually need.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#75715e">// App.tsx
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// HTTP client module
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">httpClientEnv</span>: <span style="color:#66d9ef">HttpClientEnv</span> <span style="color:#f92672">=</span> {
  <span style="color:#a6e22e">httpClient</span>: <span style="color:#66d9ef">fetchHttpClient</span>,
}

<span style="color:#75715e">// Storage module
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">storageEnv</span>: <span style="color:#66d9ef">StorageEnv</span> <span style="color:#f92672">=</span> {
  <span style="color:#a6e22e">storage</span>: <span style="color:#66d9ef">domStorage</span>,
}

<span style="color:#75715e">// Logger (added for demonstration purposes)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">loggerEnv</span>: <span style="color:#66d9ef">LoggerEnv</span> <span style="color:#f92672">=</span> {
  <span style="color:#a6e22e">logger</span>: <span style="color:#66d9ef">consoleLogger</span>
}

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">AppEnv</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">HttpClientEnv</span> <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">StorageEnv</span> <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">LoggerEnv</span>

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">appEnv</span>: <span style="color:#66d9ef">AppEnv</span> <span style="color:#f92672">=</span> { ...<span style="color:#a6e22e">httpClientEnv</span>, ...<span style="color:#a6e22e">storageEnv</span>, ...<span style="color:#a6e22e">loggerEnv</span> }

<span style="color:#75715e">// AppEnv context
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">AppEnvContext</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">React</span>.<span style="color:#a6e22e">createContext</span>(<span style="color:#a6e22e">appEnv</span>)

<span style="color:#75715e">// AppEnv custom hook
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">useAppEnv</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">useContext</span>(<span style="color:#a6e22e">AppEnvContext</span>)

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">App</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {
  <span style="color:#66d9ef">return</span> (
    &lt;<span style="color:#f92672">AppEnvContext.Provider</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">appEnv</span>}&gt;
      &lt;<span style="color:#f92672">DogsApp</span> /&gt;
    &lt;/<span style="color:#f92672">AppEnvContext.Provider</span>&gt;
  )
}

<span style="color:#75715e">// DogsApp.tsx
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">DogsApp</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {

  <span style="color:#75715e">// This could all be wrapped up into another custom hook
</span><span style="color:#75715e"></span>
  <span style="color:#75715e">// This is convenient from a usage perspective, but makes this component dependent on the full AppEnv,
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// even if we&#39;re only using a subset of it. E.g. here, we&#39;re not using `LoggerEnv`, but we have to
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// provide it via the context to satisfy the AppEnv type
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">appEnv</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">useAppEnv</span>()

  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">remoteData</span>, <span style="color:#a6e22e">setRemoteData</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useState</span>&lt;<span style="color:#f92672">RD.RemoteData</span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">HttpError</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Breeds</span>&gt;(<span style="color:#a6e22e">RD</span>.<span style="color:#a6e22e">initial</span>)

  <span style="color:#a6e22e">useEffect</span>(() <span style="color:#f92672">=&gt;</span> {
    <span style="color:#a6e22e">setRemoteData</span>(<span style="color:#a6e22e">RD</span>.<span style="color:#a6e22e">pending</span>)
    <span style="color:#a6e22e">RTE</span>.<span style="color:#a6e22e">run</span>(<span style="color:#a6e22e">getBreedsWithCache</span>, <span style="color:#a6e22e">appEnv</span>)
      .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">E</span>.<span style="color:#a6e22e">fold</span>(
        <span style="color:#a6e22e">e</span> <span style="color:#f92672">=&gt;</span> { <span style="color:#a6e22e">setRemoteData</span>(<span style="color:#a6e22e">RD</span>.<span style="color:#a6e22e">failure</span>(<span style="color:#a6e22e">e</span>) },
        <span style="color:#a6e22e">a</span> <span style="color:#f92672">=&gt;</span> { <span style="color:#a6e22e">setRemoteData</span>(<span style="color:#a6e22e">RD</span>.<span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">a</span>) },
      ))
  }, [])
  <span style="color:#75715e">// End stuff for custom hook
</span><span style="color:#75715e"></span>
  <span style="color:#75715e">// Render remoteData
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> &lt;&gt;...&lt;/&gt;
}
</code></pre></div><h3 id="more-methods">
  More methods
  <a class="heading-link" href="#more-methods">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<p>Because <code>RTE</code> dependencies are just normal function arguments, you can pass them around as such. You don&rsquo;t have to use <code>Context</code> for dealing with dependencies - it just seems like kind of the least-friction way to do it in React. The downside of <code>Context</code> is that it creates an implicit dependency in your component with some externally-provided service, so be aware of this secret dependency causing problems.</p>
<p>The upside of <code>Context</code> is that it&rsquo;s fairly easy to provide mock implementations of dependencies by just wrapping your components in <code>Provider</code>s that just inject dummy or mock versions of your dependencies. E.g. in storybook, you&rsquo;d just need to provide whatever services your component needs, rather than the entire Redux store or a huge stack of strange and unrelated junk.</p>
<h1 id="service-layers-and-implementation-hiding">
  Service layers and implementation hiding
  <a class="heading-link" href="#service-layers-and-implementation-hiding">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<p>One thing that feels a little bad about a function like <code>getBreedsWithCache</code>, which directly depends on <code>HttpClientEnv</code> and <code>StorageEnv</code> through the <code>Reader</code> arg, is that we&rsquo;re exposing our implementation details, and perhaps providing too much power to the users, since they now have to deal with the <code>HttpClient</code> and <code>Storage</code> dependencies directly. Also, the user of this function unfortunately gains access to these lower-level services too, which gives them the power to do unwanted things.</p>
<p>One thing you can do to hide these details is to layer your services and provide these more abstract services with the implementations pre-provided via applying the <code>Reader</code> args. I will not go into a lot of detail, but something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#75715e">// More abstract domain-level service, suitable for use in app components
</span><span style="color:#75715e">// (or at least more suitable than the HttpClient or Storage services)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">BreedService</span>&lt;<span style="color:#f92672">E</span>&gt; {
  <span style="color:#a6e22e">getBreeds</span>: <span style="color:#66d9ef">TE.TaskEither</span>&lt;<span style="color:#f92672">E</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Breeds</span>&gt;
}

<span style="color:#75715e">// RTE module interface
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">BreedServiceEnv</span>&lt;<span style="color:#f92672">E</span>&gt; {
  <span style="color:#a6e22e">breedService</span>: <span style="color:#66d9ef">BreedService</span>&lt;<span style="color:#f92672">E</span>&gt;
}

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HttpError</span> <span style="color:#f92672">=</span>
  <span style="color:#f92672">|</span> <span style="color:#a6e22e">HttpRequestError</span>
  <span style="color:#f92672">|</span> <span style="color:#a6e22e">HttpContentTypeError</span>
  <span style="color:#f92672">|</span> <span style="color:#a6e22e">HttpResponseStatusError</span>
  <span style="color:#f92672">|</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errors</span>

<span style="color:#75715e">// Reader that takes the RTE&#39;s env inputs and just applies them to the RTE, leaving behind just ready-to-run TaskEither
</span><span style="color:#75715e">// which hides the implementation of the interface.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">breedServiceWithCache</span>: <span style="color:#66d9ef">R.Reader</span><span style="color:#f92672">&lt;</span>
  <span style="color:#a6e22e">HttpClientEnv</span> <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">StorageEnv</span>,
  <span style="color:#a6e22e">BreedService</span>&lt;<span style="color:#f92672">HttpError</span>&gt;
<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">pipe</span>(
  <span style="color:#a6e22e">R</span>.<span style="color:#a6e22e">ask</span>&lt;<span style="color:#f92672">HttpClientEnv</span> <span style="color:#960050;background-color:#1e0010">&amp;</span> <span style="color:#a6e22e">StorageEnv</span>&gt;(),
  <span style="color:#a6e22e">R</span>.<span style="color:#a6e22e">map</span>(
    (<span style="color:#a6e22e">env</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">BreedService</span>&lt;<span style="color:#f92672">HttpError</span>&gt; <span style="color:#f92672">=&gt;</span> ({
      <span style="color:#a6e22e">getBreeds</span>: <span style="color:#66d9ef">getBreedsWithCache</span>(<span style="color:#a6e22e">env</span>), <span style="color:#75715e">// Apply the `Reader` arg, leaving just the TaskEither
</span><span style="color:#75715e"></span>    }),
  ),
)
</code></pre></div><p>Here, we&rsquo;ve created a more abstract <code>BreedService</code> interface, which does not expose the underlying implementation details of <code>HttpClient</code> and <code>Storage</code>.An implementation of this interface can be created using a plain old <code>Reader</code> from the required <code>HttpClientEnv &amp; StorageEnv</code> reader dependencies into an instance of the <code>BreedService</code>. We&rsquo;ve layered the <code>BreedService</code> on top of the lower-level services and hidden the details from a prospective user of this interface. The error type <code>E</code> <strong>is exposed</strong> via the interface because the error type could change depending on the underlying implementation, so we&rsquo;d want the caller to have the opportunity to deal with different error types. Exposing the error type in the interface is desirable, because you&rsquo;d want your users to know if you changed the implementation in a way that resulted in the possibility of different types of errors. You could alternatively abstract the error type away if you wanted to hide that implementation detail too. One final note on this is that you can partially provide the <code>Reader</code> dependencies and leave others unprovided. It might be the case that you want to expose certain dependencies at certain levels, but hide them in other layers. This can be done by providing a subset of a function&rsquo;s overall dependencies, and leaving the others still needed, to be provided elsewhere.</p>
<p>This <code>BreedService</code> could be exposed to components in the same way as the lower-level env services, using <code>Context</code> and corresponding custom hooks. In this case, the caller would have something like <code>useBreedService</code>, which provides the instance of the <code>BreedService&lt;E&gt;</code> interface with the dependencies already provided or baked-in.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#75715e">// App.tsx
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// HTTP client module
</span><span style="color:#75715e">// This could be exposed as its own context if you want callers to be able to get it directly, but here we&#39;ll hide it
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">httpClientEnv</span>: <span style="color:#66d9ef">HttpClientEnv</span> <span style="color:#f92672">=</span> {
  <span style="color:#a6e22e">httpClient</span>: <span style="color:#66d9ef">fetchHttpClient</span>,
}

<span style="color:#75715e">// Storage module
</span><span style="color:#75715e">// This could be exposed as its own context if you want callers to be able to get it directly, but here we&#39;ll hide it
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">storageEnv</span>: <span style="color:#66d9ef">StorageEnv</span> <span style="color:#f92672">=</span> {
  <span style="color:#a6e22e">storage</span>: <span style="color:#66d9ef">domStorage</span>,
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">AppEnv</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">HttpClientEnv</span> <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">StorageEnv</span>

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">appEnv</span>: <span style="color:#66d9ef">AppEnv</span> <span style="color:#f92672">=</span> { ...<span style="color:#a6e22e">httpClientEnv</span>, ...<span style="color:#a6e22e">storageEnv</span> }

<span style="color:#75715e">// Create our implementation of the interface which applies the dependencies
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">breedServiceImpl</span>: <span style="color:#66d9ef">BreedService</span>&lt;<span style="color:#f92672">HttpError</span>&gt; <span style="color:#f92672">=</span> <span style="color:#a6e22e">breedServiceWithCache</span>(<span style="color:#a6e22e">appEnv</span>)

<span style="color:#75715e">// BreedService module which hides the dependencies
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">breedServiceEnv</span>: <span style="color:#66d9ef">BreedServiceEnv</span>&lt;<span style="color:#f92672">HttpError</span>&gt; <span style="color:#f92672">=</span> {
  <span style="color:#a6e22e">breedService</span>: <span style="color:#66d9ef">breedServiceImpl</span>
}

<span style="color:#75715e">// Custom context to get just the BreedService&lt;E&gt; (here E is HttpError because of our chosen implementation)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">BreedServiceContext</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">React</span>.<span style="color:#a6e22e">createContext</span>(<span style="color:#a6e22e">breedServiceEnv</span>)

<span style="color:#75715e">// Users of this get an `BreedService&lt;E&gt;` where `E` depends on the chosen implementation, which is configured at this level
</span><span style="color:#75715e">// Users do not get access to the underlying HttpClientEnv or StorageEnv.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">useBreedService</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">useContext</span>(<span style="color:#a6e22e">BreedServiceContext</span>)

<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">App</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {
  <span style="color:#66d9ef">return</span> (
    &lt;<span style="color:#f92672">BreedServiceContext.Provider</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">breedServiceEnv</span>}&gt;
      &lt;<span style="color:#f92672">DogsApp</span> /&gt;
    &lt;/<span style="color:#f92672">BreedServiceContext.Provider</span>&gt;
  )
}

<span style="color:#75715e">// DogsApp.tsx
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">DogsApp</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {

  <span style="color:#75715e">// This could all be wrapped up into another custom hook
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">breedService</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">useBreedService</span>()

  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">remoteData</span>, <span style="color:#a6e22e">setRemoteData</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useState</span>&lt;<span style="color:#f92672">RD.RemoteData</span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">HttpError</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">Breeds</span>&gt;(<span style="color:#a6e22e">RD</span>.<span style="color:#a6e22e">initial</span>)

  <span style="color:#a6e22e">useEffect</span>(() <span style="color:#f92672">=&gt;</span> {
    <span style="color:#a6e22e">setRemoteData</span>(<span style="color:#a6e22e">RD</span>.<span style="color:#a6e22e">pending</span>)
    <span style="color:#a6e22e">breedService</span>.<span style="color:#a6e22e">getBreeds</span>() <span style="color:#75715e">// getBreeds is a TaskEither, so just call it to create the Promise and run it
</span><span style="color:#75715e"></span>      .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">E</span>.<span style="color:#a6e22e">fold</span>(
        <span style="color:#a6e22e">e</span> <span style="color:#f92672">=&gt;</span> { <span style="color:#a6e22e">setRemoteData</span>(<span style="color:#a6e22e">RD</span>.<span style="color:#a6e22e">failure</span>(<span style="color:#a6e22e">e</span>) },
        <span style="color:#a6e22e">a</span> <span style="color:#f92672">=&gt;</span> { <span style="color:#a6e22e">setRemoteData</span>(<span style="color:#a6e22e">RD</span>.<span style="color:#a6e22e">success</span>(<span style="color:#a6e22e">a</span>) },
      ))
  }, [])
  <span style="color:#75715e">// End stuff for custom hook
</span><span style="color:#75715e"></span>
  <span style="color:#75715e">// Render remoteData
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> &lt;&gt;...&lt;/&gt;
}
</code></pre></div><p>With this implementation, we&rsquo;ve exposed more domain-level services for our components to use, and hidden some of the lower-level dependencies. With this approach, you&rsquo;d probably want to use the &ldquo;context per service&rdquo; approach, and make your components only depend on the exact dependencies they need. You typically want to make your dependencies as small as possible, so that the components limit their dependency on things they don&rsquo;t need.</p>
<p>There&rsquo;s not necessarily a right or wrong way to implement these things - this is intended to just go over some of the many approaches that one can take.</p>
<h1 id="conclusion">
  Conclusion
  <a class="heading-link" href="#conclusion">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<p><code>ReaderTaskEither</code> is a flexible and highly-expressive effect type for building applications. We can compose effect functions and layer them from the low-level infrastructure services, up to application-level services. We can expose these effects to our components using a variety of techniques, including <code>React</code> <code>Context</code> and custom hooks.</p>

      </div>


      <footer>
        


        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "andywhite-xyz" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        
        
      </footer>
    </article>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [
          ['$', '$'], ['\\(', '\\)']
        ],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>
  </section>

      </div>

      
  <footer class="footer">
    <section class="container">
      
      
      
      
    </section>
  </footer>


    </main>

    
      
        
        <script src="https://andywhite.xyz/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js"></script>
      
    

    

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-151733054-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


    

    

    

    

    
  </body>

</html>
